# Fortik

## Заметки
- В Fortik не всегда используется постфиксная форма выражений
(пример - `to`, `is`)

## Описание языка
### Общее описание
Fortik - стековый язык (схожий с языками Forth и Postscript),
в котором используется постфиксная форма записи выражений и
аргументы функций, преимущественно, заранее заносятся на стек.

### Виртуальная машина
Виртуальная машина имеет:
- Счётчик команд (pc)
- Стек (stack)
- Память кода (code)
- Пространство имён (scope) (словарь вида ключ-значение)

Формат команды виртуальной машины состоит из 3 младших бит,
кодирующих операцию и 29 старших бит, кодирующих аргумент операции:

`☐☐☐|☐☐☐☐☐☐☐☐☐☐☐☐☐☐☐☐☐☐☐☐☐☐☐☐☐☐☐☐☐`

В начале массива с байткодом содержится адрес точки
входа (entry) – адрес выполнения главного кода.

### Стандартная библиотека
#### Встроенные команды (6/8):
- `push` - занести значение в стек
- `op` - выполнить библиотечную операцию
- `call` - вызов пользовательской функции или получение значения
переменной по ключу
- `is` - занести в scope аргумент как функцию
- `to` - занести в scope аргумент как переменную
- `exit` - выйти из функции

#### Встроенные операции (21/2^29):
- `+` - сложение
- `-` - вычитание
- `*` - умножение
- `/` - целочисленное деление
- `%` - остаток от деления
- `&` - AND
- `|` - OR
- `^` - XOR
- `<` - больше чем
- `>` - меньше чем
- `=` - равно
- `<<` - побитовый сдвиг влево
- `>>` - побитовый сдвиг вправо
- `if` - условный оператор
- `for` - цикл
- `.` - вывод значения на экран
- `emit` - вывод символа на экран
- `?` - ввод из консоли
- `array` - выделить массив и вернуть ссылку на него
- `@` - чтение элемента из массива по индексу
- `!` - запись элемента в массив по индексу

## Задания

### 1. Дизассемблер байткода
#### Пример использования
`>>> disasm([0, 16, 16, 1, 121, 5])`
```
entry:
  push 2
  push 2
  op '+'
  op '.'
  exit 0
```

### 2. Виртуальная машина


### 3-6. Реализация операций
Операции `is`, `call`, `emit`, `to`, `if`, `for`, работа с массивом

### 7. Парсер
#### Пример разбора:
```
[ to n  n 2 < [ 1 ] [ n n 1 - fact * ] if ] is fact
5 fact .
```

```
>>> parse(source)
[('push',
  [('to', 'n'),
   ('call', 'n'),
   ('push', 2),
   ('op', '<'),
   ('push', [('push', 1)]),
   ('push',
    [('call', 'n'),
     ('call', 'n'),
     ('push', 1),
     ('op', '-'),
     ('call', 'fact'),
     ('op', '*')]),
   ('op', 'if')]),
 ('is', 'fact'),
 ('push', 5),
 ('call', 'fact'),
 ('op', '.')]
```

Для лексического разбора можно использовать метод split.
Хороший код занимает не более 17-20 строк c:

### 8. Интерпретатор

### 9. REPL

### 10. Компилятор в байткод


# Формализация ТЗ

### Парсинг - Лексический анализ
Т.к. в языке все лексемы разделены пробелами, достаточно воспользоваться
методом split для реализации лексера. По этой причине лексер можно
реализовать внутри парсера - это не причинит неудобств впоследствии.

Типы лексем:
- Число
- `[`
- `]`
- Команда
- Оператор
- Идентификатор (обязательно выполнять **после** всего вышеперечисленного)

### Парсинг - Синтаксический анализ
Общие правила:
- `[`, `]` ограничивают самостоятельные блоки кода

Какие проблемы можно отловить на этапе парсинга:
- Забытый знак `]`
- Неправильная передача аргументов в функцию, (но только
в пределах исходного кода, который парсится на данный момент, т.к.
стек общий и информации о функциях в байткоде нет)
- Неопределённый идентификатор (опять же, только в пределах исходного
кода, который парсится)

### Преобразование AST в байткод
Для преобразования код команды записывается в первые 3 бита, а следующие
29 бит выделяются под аргумент


# Реализация

# Доработка
## `split` не выход
Из-за использования при лексическом разборе исходного кода метода split:
- Парсинг больших файлов требует полной загрузки исходного кода
в оперативную память
- Нельзя (без извращений) реализовать отображение места, в котором произошла
ошибка времени компиляции

Следует отказаться от `split` в пользу традиционного 'поточного' разбора


# Дополнительные возможности

## Bytecode v2
Позволяет:
- Сохранять в байткод версию компилятора
- Сохранять в байткод информацию о расширениях
## Импорт из внешних файлов

## Расширения
